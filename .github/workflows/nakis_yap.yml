name: Janome MB4 Tam Otomatik Üretim

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      metin:
        description: 'Nakış Yazısı'
        required: false
        default: 'PIVAZ'
      boyut:
        description: 'Yazı Boyutu (80-120)'
        required: false
        default: '100'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Kodlari Cek
        uses: actions/checkout@v4

      - name: Python Hazirla
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Kutuphaneleri Kur
        run: pip install pyembroidery Pillow numpy

      - name: Nakis Sistemini Calistir
        run: |
          cat <<EOF > create_embroidery.py
          import pyembroidery
          from PIL import Image, ImageFont, ImageDraw
          import numpy as np

          def nakis_uret(metin, boyut_str):
              # Boş değer gelirse varsayılan ayarlar
              metin = metin if metin else "PIVAZ"
              boyut = int(boyut_str) if boyut_str else 100
              
              pattern = pyembroidery.EmbPattern()
              font_yolu = "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"
              
              try:
                  font = ImageFont.truetype(font_yolu, boyut)
              except:
                  font = ImageFont.load_default()

              # 1. Metni Görsele Çiz
              dummy_img = Image.new('L', (1, 1))
              draw = ImageDraw.Draw(dummy_img)
              bbox = draw.textbbox((0, 0), metin, font=font)
              w, h = bbox[2] - bbox[0], bbox[3] - bbox[1]
              
              img = Image.new('L', (w + 100, h + 100), 0)
              draw = ImageDraw.Draw(img)
              draw.text((50, 50), metin, font=font, fill=255)
              img.save("onizleme.png")
              
              data = np.array(img)
              yukseklik, genislik = data.shape
              
              # 2. Dikiş Ayarları
              ADIM = 4 # Dikiş sıklığı (Netlik için)
              
              # 3. Akıllı Tarama (Makine Dostu)
              for x in range(0, genislik, ADIM):
                  sutun = data[:, x]
                  dolu = np.where(sutun > 128)[0]
                  
                  if len(dolu) > 0:
                      gruplar = np.split(dolu, np.where(np.diff(dolu) > 2)[0] + 1)
                      
                      for grup in gruplar:
                          if len(grup) < 3: continue
                          ust, alt = grup[0], grup[-1]
                          
                          nx = (x - genislik / 2) * 10
                          ny_ust = (ust - yukseklik / 2) * 10
                          ny_alt = (alt - yukseklik / 2) * 10
                          
                          # Yeni harfe geçerken makineye 'TRIM' (İp Kes) komutu ver
                          if x > 0 and len(np.where(data[:, x-ADIM] > 128)[0]) == 0:
                              pattern.add_stitch_absolute(pyembroidery.TRIM, int(nx), int(ny_ust))
                          
                          # Underlay: Harf boğulmasın diye alta destek
                          pattern.add_stitch_absolute(pyembroidery.STITCH, int(nx), int((ny_ust+ny_alt)/2))
                          
                          # Satin: Üste kaliteli sargı
                          pattern.add_stitch_absolute(pyembroidery.STITCH, int(nx), int(ny_ust))
                          pattern.add_stitch_absolute(pyembroidery.STITCH, int(nx + (ADIM/2)), int(ny_alt))
                  
              pattern.add_command(pyembroidery.END)
              pattern = pattern.get_normalized_pattern()
              pyembroidery.write(pattern, "nakis_final.dst")
              pyembroidery.write(pattern, "nakis_final.jef")

          if __name__ == "__main__":
              # GitHub inputlarını güvenli bir şekilde oku
              m = "${{ github.event.inputs.metin }}"
              b = "${{ github.event.inputs.boyut }}"
              nakis_uret(m, b)
          EOF
          python create_embroidery.py

      - name: Dosyalari Yukle
        uses: actions/upload-artifact@v4
        with:
          name: JANOME_MB4_CIKTI
          path: |
            nakis_final.dst
            nakis_final.jef
            onizleme.png
