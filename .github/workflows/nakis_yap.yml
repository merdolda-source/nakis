name: Janome MB4 Yazi Uretim PRO

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    # === SADECE BURAYI DEĞİŞTİREREK YAZI / ÖLÇÜYÜ AYARLIYORSUN ===
    env:
      MB4_TEXT: "PIVAZ"          # İŞLENECEK YAZI / İSİM
      MB4_WIDTH_MM: "120"        # TOPLAM GENİŞLİK (mm)
      MB4_HEIGHT_MM: "70"        # TOPLAM YÜKSEKLİK (mm)
      MB4_DENSITY: "3"           # DOLGU YOĞUNLUĞU (1=seyrek, 5=sık)
      MB4_STITCH_LIMIT: "98000"  # MAKS. DİKİŞ SAYISI (MB4 için güvenli)
      MB4_FONT_PATH: "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"

    steps:
      - name: Kodlari Cek
        uses: actions/checkout@v4

      - name: create_mb4_text.py Olustur
        run: |
          cat << 'EOF' > create_mb4_text.py
          import os

          import pyembroidery
          from PIL import Image, ImageDraw, ImageFont


          def clamp(value, min_v, max_v):
              return max(min_v, min(value, max_v))


          def density_params(density: int):
              """
              density: 1 (seyrek) - 5 (sık)
              Sonuç: (satir_arasi_mm, dikiş_arasi_mm)
              """
              density = clamp(density, 1, 5)
              # 1 -> (1.5, 2.5), 3 -> (1.1, 1.9), 5 -> (0.7, 1.3)
              row_mm = 1.5 - 0.2 * (density - 1)
              stitch_mm = 2.5 - 0.3 * (density - 1)
              row_mm = max(0.6, row_mm)
              stitch_mm = max(1.0, stitch_mm)
              return row_mm, stitch_mm


          def create_mb4_text():
              UNIT = 10  # 10 birim = 1 mm (DST/JEF ölçeği)

              # --- Ortam değişkenlerinden ayarlar ---
              text = os.getenv("MB4_TEXT", "PIVAZ").strip() or "MB4"
              width_mm = float(os.getenv("MB4_WIDTH_MM", "120"))
              height_mm = float(os.getenv("MB4_HEIGHT_MM", "70"))
              density_raw = os.getenv("MB4_DENSITY", "3")
              try:
                  density = int(density_raw)
              except ValueError:
                  density = 3
              stitch_limit = int(os.getenv("MB4_STITCH_LIMIT", "98000"))
              font_path = os.getenv(
                  "MB4_FONT_PATH",
                  "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf",
              )

              # --- 1) Yazıyı resim olarak çiz ---
              img_w, img_h = 800, 400  # çalışma alanı
              img = Image.new("L", (img_w, img_h), 0)
              draw = ImageDraw.Draw(img)

              try:
                  font = ImageFont.truetype(font_path, size=int(img_h * 0.7))
              except OSError:
                  # Font bulunamazsa yine de çalışsın
                  font = ImageFont.load_default()

              bbox_text = draw.textbbox((0, 0), text, font=font)
              text_w = bbox_text[2] - bbox_text[0]
              text_h = bbox_text[3] - bbox_text[1]

              x = (img_w - text_w) // 2 - bbox_text[0]
              y = (img_h - text_h) // 2 - bbox_text[1]
              draw.text((x, y), text, fill=255, font=font)

              # Önizleme için PNG kaydet (kontrol amaçlı)
              img.convert("RGB").save("mb4_preview.png")

              # Gerçek dolu alan bounding box
              bbox = img.getbbox()
              if not bbox:
                  raise ValueError("Yazı boş çıktı, MB4_TEXT ayarını kontrol et.")
              left, top, right, bottom = bbox

              # PIL bbox: right, bottom EXCLUSIVE -> inclusive'e çevir
              right -= 1
              bottom -= 1

              text_w_px = right - left + 1
              text_h_px = bottom - top + 1

              # --- 2) Piksel -> nakış ölçeği ---
              width_units = width_mm * UNIT
              height_units = height_mm * UNIT

              scale_x = width_units / float(text_w_px)
              scale_y = height_units / float(text_h_px)
              scale = min(scale_x, scale_y)

              cx_px = (left + right) / 2.0
              cy_px = (top + bottom) / 2.0

              mm_per_px = scale / UNIT

              row_mm, stitch_mm = density_params(density)

              # satırlar arası piksel adımı
              row_step_px = max(1, int(round(row_mm / mm_per_px)))
              # dikişler arası piksel adımı
              stitch_step_px = max(1, int(round(stitch_mm / mm_per_px)))

              # --- 3) Tatami dolgu (yatay satırlar) ---
              pattern = pyembroidery.EmbPattern()
              total_stitches = 0

              def add_stitch(cmd, x_units, y_units):
                  nonlocal total_stitches
                  if total_stitches >= stitch_limit:
                      return
                  pattern.add_stitch_absolute(
                      cmd,
                      int(round(x_units)),
                      int(round(y_units)),
                  )
                  if cmd in (pyembroidery.STITCH, pyembroidery.JUMP, pyembroidery.TRIM):
                      total_stitches += 1

              pixels = img.load()

              # Yatay satırlar boyunca dolu segmentleri bulup doldur
              for y_px in range(top, bottom + 1, row_step_px):
                  inside_segment = False
                  seg_start = None

                  for x_px in range(left, right + 1):
                      val = pixels[x_px, y_px]

                      if not inside_segment and val >= 128:
                          # beyaza girdik -> segment başı
                          inside_segment = True
                          seg_start = x_px
                      elif inside_segment and val < 128:
                          # segment bitti
                          inside_segment = False
                          seg_end = x_px - 1

                          start_px = seg_start
                          end_px = seg_end
                          y_units = (y_px - cy_px) * scale

                          # Segment başına JUMP
                          x0_units = (start_px - cx_px) * scale
                          add_stitch(pyembroidery.JUMP, x0_units, y_units)

                          # Segmenti STITCH ile doldur (max ~2-3mm aralık)
                          for xx in range(start_px, end_px + 1, stitch_step_px):
                              x_units = (xx - cx_px) * scale
                              add_stitch(pyembroidery.STITCH, x_units, y_units)

                  # Satır sonunda hâlâ segment içindeysek onu da kapat
                  if inside_segment:
                      seg_end = right
                      start_px = seg_start
                      end_px = seg_end
                      y_units = (y_px - cy_px) * scale

                      x0_units = (start_px - cx_px) * scale
                      add_stitch(pyembroidery.JUMP, x0_units, y_units)

                      for xx in range(start_px, end_px + 1, stitch_step_px):
                          x_units = (xx - cx_px) * scale
                          add_stitch(pyembroidery.STITCH, x_units, y_units)

              # Merkeze normalize et, desen sonu
              pattern = pattern.get_normalized_pattern()
              pattern.end()

              # Çıkış dosyaları
              pyembroidery.write(pattern, "mb4_text.dst")
              pyembroidery.write(pattern, "mb4_text.jef")

              print("Metin:", text)
              print("Genişlik x Yükseklik (mm):", width_mm, "x", height_mm)
              print("Yoğunluk:", density, "(1=seyrek, 5=sık)")
              print("Toplam dikiş:", total_stitches)


          if __name__ == "__main__":
              create_mb4_text()
          EOF

      - name: Python Hazirla
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Kütüphaneleri Kur
        run: |
          sudo apt-get update -y
          sudo apt-get install -y fonts-dejavu-core
          pip install pyembroidery pillow

      - name: Nakis Dosyalarini Uret
        run: python create_mb4_text.py

      - name: Dosyalari Yukle
        uses: actions/upload-artifact@v4
        with:
          name: JANOME_MB4_TEXT
          path: |
            mb4_text.dst
            mb4_text.jef
            mb4_preview.png
