name: Janome MB4 Uretim - Modern PIVAZ

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Kodlari Cek
        uses: actions/checkout@v4

      - name: create_pivaz.py Olustur
        run: |
          cat << 'EOF' > create_pivaz.py
          import math
          import pyembroidery

          STITCH_LIMIT = 99000  # Janome MB4 için güvenli üst sınır

          def mb4_kesin_cozum():
              pattern = pyembroidery.EmbPattern()
              total_stitches = 0

              # Güvenli dikiş ekleme fonksiyonu (limit kontrolü ile)
              def add_stitch(cmd, x, y):
                  nonlocal total_stitches, pattern
                  if total_stitches >= STITCH_LIMIT:
                      return
                  pattern.add_stitch_absolute(cmd, int(round(x)), int(round(y)))
                  if cmd in (pyembroidery.STITCH, pyembroidery.JUMP, pyembroidery.TRIM):
                      total_stitches += 1

              def doldur_cizgi(x1, y1, x2, y2,
                               kolon_genislik=70,   # Kolon kalınlığı (nakış genişliği)
                               aralik_uzunluk=18,   # Dikişler arası mesafe (hat boyunca) ~1.8mm
                               aralik_genislik=10   # Paralel hatlar arası mesafe ~1mm
                               ):
                  """
                  Verilen çizgiyi tek çizgi yerine kalın bir nakış kolonu
                  gibi doldurur. (satin/tatami hissi)
                  """
                  dx = x2 - x1
                  dy = y2 - y1
                  uzunluk = math.hypot(dx, dy)
                  if uzunluk == 0:
                      return

                  # Çizgi boyunca birim vektörler
                  nx = -dy / uzunluk  # Normale dik (kalınlık yönü)
                  ny = dx / uzunluk

                  bas = -kolon_genislik / 2.0
                  bit = kolon_genislik / 2.0
                  offset = bas
                  yon = 1  # Boustrophedon: bir satır ileri, bir satır geri

                  while offset <= bit and total_stitches < STITCH_LIMIT:
                      # Bu offset için başlangıç ve bitiş noktası
                      sx = x1 + nx * offset
                      sy = y1 + ny * offset
                      ex = x2 + nx * offset
                      ey = y2 + ny * offset

                      adim_sayisi = max(int(uzunluk // aralik_uzunluk), 1)

                      if yon == 1:
                          # Satırı baştan sona
                          add_stitch(pyembroidery.JUMP, sx, sy)
                          for i in range(1, adim_sayisi + 1):
                              t = i / adim_sayisi
                              x = sx + (ex - sx) * t
                              y = sy + (ey - sy) * t
                              add_stitch(pyembroidery.STITCH, x, y)
                      else:
                          # Bir sonraki satırı tersten (geri dönüş)
                          add_stitch(pyembroidery.JUMP, ex, ey)
                          for i in range(1, adim_sayisi + 1):
                              t = i / adim_sayisi
                              x = ex + (sx - ex) * t
                              y = ey + (sy - ey) * t
                              add_stitch(pyembroidery.STITCH, x, y)

                      yon *= -1
                      offset += aralik_genislik

              # ===== PIVAZ Tasarımı (120x70mm alan içinde merkezli) =====
              # P
              doldur_cizgi(-500,  300, -500, -300)
              doldur_cizgi(-500, -300, -300, -300)
              doldur_cizgi(-300, -300, -300,    0)
              doldur_cizgi(-300,    0, -500,    0)

              # I
              doldur_cizgi(-200,  300, -200, -300)

              # V
              doldur_cizgi(-100, -300,    0,  300)
              doldur_cizgi(   0,  300,  100, -300)

              # A
              doldur_cizgi( 200,  300,  350, -300)
              doldur_cizgi( 350, -300,  500,  300)
              doldur_cizgi( 275,    0,  425,    0)

              # Z
              doldur_cizgi( 600, -300,  800, -300)
              doldur_cizgi( 800, -300,  600,  300)
              doldur_cizgi( 600,  300,  800,  300)

              # Normalize (merkeze al, yönleri düzelt)
              pattern = pattern.get_normalized_pattern()

              pyembroidery.write(pattern, "pivaz_cikti.dst")
              pyembroidery.write(pattern, "pivaz_cikti.jef")
              print("Dosyalar uretildi. Toplam dikiş sayisi ~", total_stitches)

          if __name__ == "__main__":
              mb4_kesin_cozum()
          EOF

      - name: Python Hazirla
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Kütüphane Kur
        run: pip install pyembroidery

      - name: Dosyalari Uret
        run: python create_pivaz.py

      - name: Dosyalari Yukle
        uses: actions/upload-artifact@v4
        with:
          name: JANOME_MB4_FINAL
          path: |
            pivaz_cikti.dst
            pivaz_cikti.jef
