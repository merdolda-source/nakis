name: Janome MB4 Yazi Uretim PRO (TTF Tatami)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    # SADECE BURAYI DEĞİŞTİREREK YAZI / ÖLÇÜ / YOĞUNLUK AYARLIYORSUN
    env:
      MB4_TEXT: "PIVAZ"          # İŞLENECEK YAZI / İSİM
      MB4_WIDTH_MM: "120"        # TOPLAM GENİŞLİK (mm)
      MB4_HEIGHT_MM: "70"        # TOPLAM YÜKSEKLİK (mm)
      MB4_DENSITY: "3"           # 1 = seyrek, 5 = çok sık
      MB4_STITCH_LIMIT: "98000"  # MB4 için güvenli dikiş limiti
      MB4_FONT_PATH: "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"

    steps:
      - name: Kodlari Cek
        uses: actions/checkout@v4

      - name: create_mb4_text.py Olustur
        run: |
          cat << 'EOF' > create_mb4_text.py
          import os

          import pyembroidery
          from PIL import Image, ImageDraw, ImageFont


          UNIT = 10  # 10 birim = 1 mm (DST/JEF ölçeği)


          def clamp(v, lo, hi):
              return max(lo, min(hi, v))


          def density_params(density: int):
              """
              1 (seyrek) - 5 (sık) arasında yoğunluk.
              Dönüş: (satir_arasi_mm, dikiş_arasi_mm)
              """
              density = clamp(density, 1, 5)
              row_mm = 1.6 - 0.2 * (density - 1)     # 1.6 -> 0.8 mm arası
              stitch_mm = 2.6 - 0.3 * (density - 1)  # 2.6 -> 1.4 mm arası
              row_mm = max(0.7, row_mm)
              stitch_mm = max(1.2, stitch_mm)
              return row_mm, stitch_mm


          def create_mb4_text():
              text = os.getenv("MB4_TEXT", "PIVAZ").strip() or "MB4"
              width_mm = float(os.getenv("MB4_WIDTH_MM", "120"))
              height_mm = float(os.getenv("MB4_HEIGHT_MM", "70"))
              density_raw = os.getenv("MB4_DENSITY", "3")
              try:
                  density = int(density_raw)
              except ValueError:
                  density = 3
              stitch_limit = int(os.getenv("MB4_STITCH_LIMIT", "98000"))
              font_path = os.getenv(
                  "MB4_FONT_PATH",
                  "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf",
              )

              # --- 1) Yazıyı TTF ile resme çiz ---
              img_w, img_h = 800, 400
              img = Image.new("L", (img_w, img_h), 0)  # siyah arka plan
              draw = ImageDraw.Draw(img)

              try:
                  font = ImageFont.truetype(font_path, size=int(img_h * 0.7))
              except OSError:
                  font = ImageFont.load_default()

              bbox_text = draw.textbbox((0, 0), text, font=font)
              text_w = bbox_text[2] - bbox_text[0]
              text_h = bbox_text[3] - bbox_text[1]

              x = (img_w - text_w) // 2 - bbox_text[0]
              y = (img_h - text_h) // 2 - bbox_text[1]
              draw.text((x, y), text, fill=255, font=font)

              # Kontrol için önizleme PNG
              img.convert("RGB").save("mb4_preview.png")

              # Çizilen alanın gerçek bounding box'ı
              bbox = img.getbbox()
              if not bbox:
                  raise ValueError("Yazı boş çıktı.")
              left, top, right, bottom = bbox

              # PIL: right,bottom EXCLUSIVE -> inclusive
              right -= 1
              bottom -= 1

              text_w_px = right - left + 1
              text_h_px = bottom - top + 1

              # --- 2) Piksel -> nakış ölçeği ---
              width_units = width_mm * UNIT
              height_units = height_mm * UNIT

              scale_x = width_units / float(text_w_px)
              scale_y = height_units / float(text_h_px)
              scale = min(scale_x, scale_y)

              # Görüntü merkezi (piksel)
              cx_px = (left + right) / 2.0
              cy_px = (top + bottom) / 2.0

              mm_per_px = scale / UNIT

              row_mm, stitch_mm = density_params(density)
              row_step_px = max(1, int(round(row_mm / mm_per_px)))
              stitch_step_px = max(1, int(round(stitch_mm / mm_per_px)))

              # --- 3) Tatami dolgu (yatay satırlar) ---
              pattern = pyembroidery.EmbPattern()
              total_stitches = 0

              def add_stitch(cmd, x_units, y_units):
                  nonlocal total_stitches
                  if total_stitches >= stitch_limit:
                      return
                  pattern.add_stitch_absolute(
                      cmd,
                      int(round(x_units)),
                      int(round(y_units)),
                  )
                  if cmd in (pyembroidery.STITCH, pyembroidery.JUMP, pyembroidery.TRIM):
                      total_stitches += 1

              pixels = img.load()

              # Her satırda yazının olduğu segmentleri doldur
              for y_px in range(top, bottom + 1, row_step_px):
                  inside = False
                  seg_start = None

                  for x_px in range(left, right + 1):
                      val = pixels[x_px, y_px]

                      if not inside and val >= 128:
                          inside = True
                          seg_start = x_px
                      elif inside and val < 128:
                          inside = False
                          seg_end = x_px - 1

                          start_px = seg_start
                          end_px = seg_end

                          # Y koordinatı: normal (aşağı +)
                          y_units = (y_px - cy_px) * scale

                          # X'i ÖZELLİKLE TERS ÇEVİRİYORUZ -> aynadan çıkmasın
                          x0_units = -(start_px - cx_px) * scale
                          add_stitch(pyembroidery.JUMP, x0_units, y_units)

                          for xx in range(start_px, end_px + 1, stitch_step_px):
                              x_units = -(xx - cx_px) * scale
                              add_stitch(pyembroidery.STITCH, x_units, y_units)

                  # Satır sonunda hâlâ segmentteysek
                  if inside:
                      seg_end = right
                      start_px = seg_start
                      end_px = seg_end

                      y_units = (y_px - cy_px) * scale
                      x0_units = -(start_px - cx_px) * scale
                      add_stitch(pyembroidery.JUMP, x0_units, y_units)

                      for xx in range(start_px, end_px + 1, stitch_step_px):
                          x_units = -(xx - cx_px) * scale
                          add_stitch(pyembroidery.STITCH, x_units, y_units)

              pattern = pattern.get_normalized_pattern()
              pattern.end()

              pyembroidery.write(pattern, "mb4_text.dst")
              pyembroidery.write(pattern, "mb4_text.jef")

              print("Metin:", text)
              print("Genişlik x Yükseklik (mm):", width_mm, "x", height_mm)
              print("Yoğunluk:", density, "(1=seyrek, 5=sık)")
              print("Toplam dikiş:", total_stitches)


          if __name__ == "__main__":
              create_mb4_text()
          EOF

      - name: Python Hazirla
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Kutuphaneleri Kur
        run: |
          sudo apt-get update -y
          sudo apt-get install -y fonts-dejavu-core
          pip install pyembroidery pillow

      - name: Nakis Dosyalarini Uret
        run: python create_mb4_text.py

      - name: Dosyalari Yukle
        uses: actions/upload-artifact@v4
        with:
          name: JANOME_MB4_TEXT
          path: |
            mb4_text.dst
            mb4_text.jef
            mb4_preview.png
