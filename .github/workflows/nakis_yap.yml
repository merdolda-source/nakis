name: Janome MB4 Yazi Uretim PRO (Stroke Font)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    # SADECE BURAYI DEĞİŞTİREREK YAZI / ÖLÇÜYÜ AYARLIYORSUN
    env:
      MB4_TEXT: "PIVAZ"          # İŞLENECEK YAZI / İSİM
      MB4_WIDTH_MM: "120"        # TOPLAM GENİŞLİK (mm)
      MB4_HEIGHT_MM: "70"        # TOPLAM YÜKSEKLİK (mm)
      MB4_STROKE_MM: "1.8"       # HARF ÇİZGİ KALINLIĞI (mm, 1.2–2.5 arası idealdir)
      MB4_STITCH_LIMIT: "98000"  # MAKS. DİKİŞ SAYISI (MB4 için güvenli)

    steps:
      - name: Kodlari Cek
        uses: actions/checkout@v4

      - name: create_mb4_text.py Olustur
        run: |
          cat << 'EOF' > create_mb4_text.py
          import os
          import math

          import pyembroidery


          UNIT = 10  # 10 birim = 1 mm (DST/JEF standart)


          # Basit blok büyük harf fontu (0..1 aralığında koordinatlar)
          # Her harf: [ (x1,y1,x2,y2), ... ]
          def rect(x1, y1, x2, y2):
              return [
                  (x1, y1, x2, y1),
                  (x2, y1, x2, y2),
                  (x2, y2, x1, y2),
                  (x1, y2, x1, y1),
              ]


          FONT = {}

          # A
          FONT["A"] = [
              (0.0, 0.0, 0.5, 1.0),
              (1.0, 0.0, 0.5, 1.0),
              (0.2, 0.5, 0.8, 0.5),
          ]

          # B (yaklaşık blok B)
          FONT["B"] = [
              (0.0, 0.0, 0.0, 1.0),
              (0.0, 1.0, 0.7, 1.0),
              (0.7, 1.0, 0.7, 0.5),
              (0.7, 0.5, 0.0, 0.5),
              (0.0, 0.5, 0.7, 0.5),
              (0.7, 0.5, 0.7, 0.0),
              (0.7, 0.0, 0.0, 0.0),
          ]

          # C
          FONT["C"] = [
              (0.9, 0.1, 0.1, 0.1),
              (0.1, 0.1, 0.1, 0.9),
              (0.1, 0.9, 0.9, 0.9),
          ]

          # D
          FONT["D"] = [
              (0.0, 0.0, 0.0, 1.0),
              (0.0, 1.0, 0.7, 0.8),
              (0.7, 0.8, 0.7, 0.2),
              (0.7, 0.2, 0.0, 0.0),
          ]

          # E
          FONT["E"] = [
              (0.9, 0.0, 0.1, 0.0),
              (0.1, 0.0, 0.1, 1.0),
              (0.1, 1.0, 0.9, 1.0),
              (0.1, 0.5, 0.7, 0.5),
          ]

          # F
          FONT["F"] = [
              (0.1, 0.0, 0.1, 1.0),
              (0.1, 1.0, 0.9, 1.0),
              (0.1, 0.5, 0.7, 0.5),
          ]

          # G
          FONT["G"] = [
              (0.9, 0.1, 0.1, 0.1),
              (0.1, 0.1, 0.1, 0.9),
              (0.1, 0.9, 0.9, 0.9),
              (0.9, 0.9, 0.9, 0.5),
              (0.9, 0.5, 0.6, 0.5),
          ]

          # H
          FONT["H"] = [
              (0.1, 0.0, 0.1, 1.0),
              (0.9, 0.0, 0.9, 1.0),
              (0.1, 0.5, 0.9, 0.5),
          ]

          # I
          FONT["I"] = [
              (0.1, 1.0, 0.9, 1.0),
              (0.5, 1.0, 0.5, 0.0),
              (0.1, 0.0, 0.9, 0.0),
          ]

          # J
          FONT["J"] = [
              (0.1, 0.0, 0.7, 0.0),
              (0.7, 0.0, 0.7, 1.0),
              (0.7, 1.0, 0.1, 1.0),
          ]

          # K
          FONT["K"] = [
              (0.1, 0.0, 0.1, 1.0),
              (0.1, 0.5, 0.9, 1.0),
              (0.1, 0.5, 0.9, 0.0),
          ]

          # L
          FONT["L"] = [
              (0.1, 0.0, 0.1, 1.0),
              (0.1, 0.0, 0.9, 0.0),
          ]

          # M
          FONT["M"] = [
              (0.0, 0.0, 0.0, 1.0),
              (0.0, 1.0, 0.5, 0.5),
              (0.5, 0.5, 1.0, 1.0),
              (1.0, 1.0, 1.0, 0.0),
          ]

          # N
          FONT["N"] = [
              (0.0, 0.0, 0.0, 1.0),
              (0.0, 1.0, 1.0, 0.0),
              (1.0, 0.0, 1.0, 1.0),
          ]

          # O
          FONT["O"] = rect(0.1, 0.1, 0.9, 0.9)

          # P
          FONT["P"] = [
              (0.1, 0.0, 0.1, 1.0),
              (0.1, 1.0, 0.8, 1.0),
              (0.8, 1.0, 0.8, 0.5),
              (0.8, 0.5, 0.1, 0.5),
          ]

          # Q
          FONT["Q"] = rect(0.1, 0.1, 0.9, 0.9) + [
              (0.6, 0.1, 0.9, 0.0),
          ]

          # R
          FONT["R"] = [
              (0.1, 0.0, 0.1, 1.0),
              (0.1, 1.0, 0.8, 1.0),
              (0.8, 1.0, 0.8, 0.5),
              (0.8, 0.5, 0.1, 0.5),
              (0.1, 0.5, 0.9, 0.0),
          ]

          # S
          FONT["S"] = [
              (0.9, 0.1, 0.1, 0.1),
              (0.1, 0.1, 0.1, 0.5),
              (0.1, 0.5, 0.9, 0.5),
              (0.9, 0.5, 0.9, 0.9),
              (0.9, 0.9, 0.1, 0.9),
          ]

          # T
          FONT["T"] = [
              (0.1, 1.0, 0.9, 1.0),
              (0.5, 1.0, 0.5, 0.0),
          ]

          # U
          FONT["U"] = [
              (0.1, 0.0, 0.1, 1.0),
              (0.9, 0.0, 0.9, 1.0),
              (0.1, 0.0, 0.9, 0.0),
          ]

          # V
          FONT["V"] = [
              (0.0, 1.0, 0.5, 0.0),
              (0.5, 0.0, 1.0, 1.0),
          ]

          # W
          FONT["W"] = [
              (0.0, 1.0, 0.25, 0.0),
              (0.25, 0.0, 0.5, 0.5),
              (0.5, 0.5, 0.75, 0.0),
              (0.75, 0.0, 1.0, 1.0),
          ]

          # X
          FONT["X"] = [
              (0.0, 0.0, 1.0, 1.0),
              (0.0, 1.0, 1.0, 0.0),
          ]

          # Y
          FONT["Y"] = [
              (0.0, 1.0, 0.5, 0.5),
              (1.0, 1.0, 0.5, 0.5),
              (0.5, 0.5, 0.5, 0.0),
          ]

          # Z
          FONT["Z"] = [
              (0.0, 1.0, 1.0, 1.0),
              (1.0, 1.0, 0.0, 0.0),
              (0.0, 0.0, 1.0, 0.0),
          ]

          # Basit rakamlar (000-999 isimlerde işine yarar)
          FONT["0"] = rect(0.1, 0.1, 0.9, 0.9)
          FONT["1"] = [
              (0.5, 0.0, 0.5, 1.0),
              (0.3, 0.0, 0.7, 0.0),
          ]
          FONT["2"] = [
              (0.1, 0.1, 0.9, 0.1),
              (0.9, 0.1, 0.9, 0.5),
              (0.9, 0.5, 0.1, 0.5),
              (0.1, 0.5, 0.1, 0.9),
              (0.1, 0.9, 0.9, 0.9),
          ]
          FONT["3"] = [
              (0.1, 0.1, 0.9, 0.1),
              (0.9, 0.1, 0.9, 0.9),
              (0.1, 0.5, 0.9, 0.5),
              (0.1, 0.9, 0.9, 0.9),
          ]
          FONT["4"] = [
              (0.1, 0.1, 0.1, 0.5),
              (0.1, 0.5, 0.9, 0.5),
              (0.9, 0.1, 0.9, 1.0),
          ]
          FONT["5"] = [
              (0.9, 0.1, 0.1, 0.1),
              (0.1, 0.1, 0.1, 0.5),
              (0.1, 0.5, 0.9, 0.5),
              (0.9, 0.5, 0.9, 0.9),
              (0.9, 0.9, 0.1, 0.9),
          ]
          FONT["6"] = [
              (0.9, 0.1, 0.1, 0.1),
              (0.1, 0.1, 0.1, 0.9),
              (0.1, 0.5, 0.9, 0.5),
              (0.1, 0.9, 0.9, 0.9),
              (0.9, 0.5, 0.9, 0.9),
          ]
          FONT["7"] = [
              (0.1, 0.9, 0.9, 0.9),
              (0.9, 0.9, 0.1, 0.1),
          ]
          FONT["8"] = rect(0.1, 0.1, 0.9, 0.9) + [
              (0.1, 0.5, 0.9, 0.5),
          ]
          FONT["9"] = [
              (0.1, 0.9, 0.9, 0.9),
              (0.9, 0.9, 0.9, 0.1),
              (0.9, 0.5, 0.1, 0.5),
              (0.1, 0.5, 0.1, 0.1),
          ]

          # Her harfin genişliği (normalized). Çoğu 1.0
          ADVANCE = {ch: 1.0 for ch in FONT.keys()}
          ADVANCE["I"] = 0.6
          ADVANCE["1"] = 0.6


          # Türkçe karakterleri Latin’e çevir
          REMAP_TR = {
              "Ç": "C",
              "Ğ": "G",
              "İ": "I",
              "I": "I",
              "Ö": "O",
              "Ş": "S",
              "Ü": "U",
          }


          def satin_line(add_stitch, x1, y1, x2, y2, stroke_mm, stitch_limit):
              """Verilen çizgiyi kalın kolon (satin hissi) gibi doldurur."""
              width_units = stroke_mm * UNIT
              dx = x2 - x1
              dy = y2 - y1
              length = math.hypot(dx, dy)
              if length == 0:
                  return

              nx = -dy / length
              ny = dx / length

              half = width_units / 2.0
              lane_step = UNIT  # 1 mm aralık
              lane = -half
              direction = 1

              while lane <= half:
                  sx = x1 + nx * lane
                  sy = y1 + ny * lane
                  ex = x2 + nx * lane
                  ey = y2 + ny * lane

                  # çizgi boyunca dikiş aralığı ~2 mm
                  steps = max(int(length / (2 * UNIT)), 1)

                  if direction == 1:
                      add_stitch(pyembroidery.JUMP, sx, sy, stitch_limit)
                      for i in range(1, steps + 1):
                          t = i / steps
                          x = sx + (ex - sx) * t
                          y = sy + (ey - sy) * t
                          add_stitch(pyembroidery.STITCH, x, y, stitch_limit)
                  else:
                      add_stitch(pyembroidery.JUMP, ex, ey, stitch_limit)
                      for i in range(1, steps + 1):
                          t = i / steps
                          x = ex + (sx - ex) * t
                          y = ey + (sy - ey) * t
                          add_stitch(pyembroidery.STITCH, x, y, stitch_limit)

                  direction *= -1
                  lane += lane_step


          def create_mb4_text():
              text_raw = os.getenv("MB4_TEXT", "PIVAZ")
              width_mm = float(os.getenv("MB4_WIDTH_MM", "120"))
              height_mm = float(os.getenv("MB4_HEIGHT_MM", "70"))
              stroke_mm = float(os.getenv("MB4_STROKE_MM", "1.8"))
              stitch_limit = int(os.getenv("MB4_STITCH_LIMIT", "98000"))

              # Yazıyı normalize et: büyük harf + TR -> Latin
              text_norm = []
              for ch in text_raw:
                  up = ch.upper()
                  up = REMAP_TR.get(up, up)
                  text_norm.append(up)
              text = "".join(text_norm)

              # Toplam normalleştirilmiş genişlik
              SPACE_ADV = 0.5
              LETTER_SPACING = 0.3

              norm_width = 0.0
              for ch in text:
                  if ch == " ":
                      norm_width += SPACE_ADV
                  elif ch in FONT:
                      norm_width += ADVANCE.get(ch, 1.0) + LETTER_SPACING
                  # bilinmeyen karakterleri atlıyoruz

              if norm_width == 0.0:
                  norm_width = 1.0

              width_units = width_mm * UNIT
              height_units = height_mm * UNIT

              scale_x = width_units / norm_width
              scale_y = height_units / 1.0  # font yüksekliği 1.0
              scale = min(scale_x, scale_y)

              pattern = pyembroidery.EmbPattern()
              total_stitches = 0

              def add_stitch(cmd, x_u, y_u, limit):
                  nonlocal total_stitches
                  if total_stitches >= limit:
                      return
                  pattern.add_stitch_absolute(
                      cmd,
                      int(round(x_u)),
                      int(round(y_u)),
                  )
                  if cmd in (pyembroidery.STITCH, pyembroidery.JUMP, pyembroidery.TRIM):
                      total_stitches += 1

              # Harfleri sırayla yerleştir
              cursor = 0.0
              for ch in text:
                  if ch == " ":
                      cursor += SPACE_ADV
                      continue
                  if ch not in FONT:
                      # desteklenmeyen karakteri atla
                      cursor += SPACE_ADV
                      continue

                  adv = ADVANCE.get(ch, 1.0)
                  x_off = cursor
                  strokes = FONT[ch]

                  for (x1, y1, x2, y2) in strokes:
                      # Normalleştirilmiş koordinattan gerçek birime geç
                      x1n = x_off + x1
                      x2n = x_off + x2
                      y1n = y1
                      y2n = y2

                      # Metnin ortasını 0,0 yap
                      x1u = (x1n - norm_width / 2.0) * scale
                      x2u = (x2n - norm_width / 2.0) * scale
                      y1u = (y1n - 0.5) * scale
                      y2u = (y2n - 0.5) * scale

                      satin_line(add_stitch, x1u, y1u, x2u, y2u, stroke_mm, stitch_limit)

                  cursor += adv + LETTER_SPACING

              pattern = pattern.get_normalized_pattern()
              pattern.end()

              pyembroidery.write(pattern, "mb4_text.dst")
              pyembroidery.write(pattern, "mb4_text.jef")

              print("Metin:", text)
              print("Toplam dikiş:", total_stitches)
              print("Norm genişlik:", norm_width, " ölçek:", scale)


          if __name__ == "__main__":
              create_mb4_text()
          EOF

      - name: Python Hazirla
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Kutuphaneleri Kur
        run: |
          pip install pyembroidery

      - name: Nakis Dosyalarini Uret
        run: python create_mb4_text.py

      - name: Dosyalari Yukle
        uses: actions/upload-artifact@v4
        with:
          name: JANOME_MB4_TEXT
          path: |
            mb4_text.dst
            mb4_text.jef
