name: Janome MB4 Profesyonel Kesintisiz Üretim

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      metin:
        description: 'Yazılacak Yazı'
        required: false
        default: 'PIVAZ'
      boyut:
        description: 'Yazı Boyutu (80-120)'
        required: false
        default: '100'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Kodlari Cek
        uses: actions/checkout@v4

      - name: Python Hazirla
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Kutuphaneleri Kur
        run: pip install pyembroidery Pillow numpy

      - name: Nakis Sistemini Calistir
        run: |
          cat <<EOF > create_embroidery.py
          import pyembroidery
          from PIL import Image, ImageFont, ImageDraw
          import numpy as np

          def nakis_uret(metin, boyut_str):
              metin = metin if metin else "PIVAZ"
              boyut = int(boyut_str) if boyut_str else 100
              
              pattern = pyembroidery.EmbPattern()
              # Kalın font kullanımı netlik için kritiktir
              font_yolu = "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"
              
              try:
                  font = ImageFont.truetype(font_yolu, boyut)
              except:
                  font = ImageFont.load_default()

              # 1. Metin Analizi
              dummy_img = Image.new('L', (1, 1))
              draw = ImageDraw.Draw(dummy_img)
              bbox = draw.textbbox((0, 0), metin, font=font)
              w, h = bbox[2] - bbox[0], bbox[3] - bbox[1]
              
              img = Image.new('L', (w + 100, h + 100), 0)
              draw = ImageDraw.Draw(img)
              draw.text((50, 50), metin, font=font, fill=255)
              img.save("onizleme.png")
              
              data = np.array(img)
              yukseklik, genislik = data.shape
              
              # 2. Profesyonel Nakış Ayarları
              ADIM = 4          # Sargı sıklığı (Daha düşük = Daha sık)
              SARG_GENISLIK = 2 # Kenar düzeltme payı
              
              # 3. Akıllı Sargı Döngüsü
              for x in range(0, genislik, ADIM):
                  sutun = data[:, x]
                  dolu = np.where(sutun > 128)[0]
                  
                  if len(dolu) > 0:
                      # Harf parçalarını ayır (P'nin altı ve üstü gibi)
                      gruplar = np.split(dolu, np.where(np.diff(dolu) > 2)[0] + 1)
                      
                      for grup in gruplar:
                          if len(grup) < 3: continue
                          ust, alt = grup[0], grup[-1]
                          
                          nx = (x - genislik / 2) * 10
                          ny_ust = (ust - yukseklik / 2) * 10
                          ny_alt = (alt - yukseklik / 2) * 10
                          
                          # --- KRİTİK: ATLAMA VE KESME KONTROLÜ ---
                          # Eğer bir önceki adımda dikiş yoksa, buraya kesinlikle JUMP ile gel
                          if x == 0 or len(np.where(data[:, x-ADIM] > 128)[0]) == 0:
                              pattern.add_stitch_absolute(pyembroidery.JUMP, int(nx), int(ny_ust))
                              # Makineye ipi kes komutu gönder (DST için en güvenlisi)
                              pattern.add_command(pyembroidery.TRIM)

                          # --- UNDERLAY (ALT DESTEK) ---
                          # Harfin boğulmaması için önce zemin dikişi
                          pattern.add_stitch_absolute(pyembroidery.STITCH, int(nx), int((ny_ust + ny_alt)/2))

                          # --- SATIN (GERÇEK SARGI) ---
                          # Bir üstten bir alttan zikzak yaparak harfi doldurur
                          pattern.add_stitch_absolute(pyembroidery.STITCH, int(nx), int(ny_ust))
                          pattern.add_stitch_absolute(pyembroidery.STITCH, int(nx + (ADIM/2)), int(ny_alt))
                  
              pattern.add_command(pyembroidery.END)
              
              # Janome BECS sistemleri için DST formatı daha stabildir
              pyembroidery.write(pattern, "nakis_final.dst")
              pyembroidery.write(pattern, "nakis_final.jef")

          if __name__ == "__main__":
              import sys
              m = "${{ github.event.inputs.metin }}"
              b = "${{ github.event.inputs.boyut }}"
              nakis_uret(m, b)
          EOF
          python create_embroidery.py

      - name: Dosyalari Yukle
        uses: actions/upload-artifact@v4
        with:
          name: JANOME_PROFESYONEL_CIKTI
          path: |
            nakis_final.dst
            nakis_final.jef
            onizleme.png
